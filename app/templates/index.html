<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLoom - CSV to SQL Schema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        .file-card {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .file-card:hover {
            background-color: #f8f9fa;
        }
        .file-card.active {
            background-color: #e9ecef;
            border-color: #0d6efd;
        }
        .preview-container {
            max-height: 400px;
            overflow: auto;
        }
        .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }
        .delete-btn {
            cursor: pointer;
            color: #dc3545;
        }
        .delete-btn:hover {
            color: #bb2d3b;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            font-weight: 500;
        }
        .schema-card {
            margin-bottom: 15px;
        }
        .schema-table {
            margin-bottom: 0;
        }
        .schema-table th {
            width: 120px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1 class="text-center mb-4">DataLoom - CSV to SQL Schema</h1>
        
        <!-- Main Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files-tab-pane" type="button" role="tab" aria-controls="files-tab-pane" aria-selected="true">
                    <i class="bi bi-file-earmark-text"></i> Files
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schema-tab" data-bs-toggle="tab" data-bs-target="#schema-tab-pane" type="button" role="tab" aria-controls="schema-tab-pane" aria-selected="false">
                    <i class="bi bi-database"></i> Database Schema
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="mainTabsContent">
            <!-- Files Tab -->
            <div class="tab-pane fade show active" id="files-tab-pane" role="tabpanel" aria-labelledby="files-tab" tabindex="0">
                <!-- Upload Form -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Upload CSV File</h5>
                            </div>
                            <div class="card-body">
                                <form id="uploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="csvFile" class="form-label">Select CSV File</label>
                                        <input class="form-control" type="file" id="csvFile" accept=".csv" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Upload</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="row">
                    <!-- File List -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Uploaded Files</h5>
                                <button class="btn btn-sm btn-outline-danger" id="deleteAllBtn" title="Delete All Files">
                                    <i class="bi bi-trash"></i> Clear All
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush" id="fileList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Preview -->
                    <div class="col-md-8">
                        <div class="card" id="previewCard" style="display: none;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0" id="previewTitle">File Preview</h5>
                                <div>
                                    <button id="deleteSelectedBtn" class="btn btn-sm btn-outline-danger me-2">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                    <button id="generateSchemaBtn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#schemaModal">Generate SQL Schema</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <h6>File Information</h6>
                                            <p id="fileInfo">No file selected</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="preview-container">
                                    <h6>Data Preview</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover" id="previewTable">
                                            <thead id="previewHeader"></thead>
                                            <tbody id="previewBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Empty State -->
                        <div class="card" id="emptyState">
                            <div class="card-body text-center py-5">
                                <h5 class="text-muted mb-3">No File Selected</h5>
                                <p class="text-muted">Upload a CSV file or select an existing file to see preview and generate SQL schema</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Database Schema Tab -->
            <div class="tab-pane fade" id="schema-tab-pane" role="tabpanel" aria-labelledby="schema-tab" tabindex="0">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Database Schema</h5>
                                <button class="btn btn-sm btn-primary" id="refreshSchemaBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="schemaContent">
                                    <div class="text-center py-3" id="schemaLoading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading schema information...</p>
                                    </div>
                                    
                                    <div id="schemaEmpty" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            No tables found in the database. Use the Files tab to upload CSV files and generate tables.
                                        </div>
                                    </div>
                                    
                                    <div id="schemaList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schema Modal -->
    <div class="modal fade" id="schemaModal" tabindex="-1" aria-labelledby="schemaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="schemaModalLabel">Generate SQL Schema</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="schemaForm">
                        <div class="mb-3">
                            <label for="tableName" class="form-label">Table Name</label>
                            <input type="text" class="form-control" id="tableName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Generated SQL</label>
                            <pre id="generatedSQL" class="p-3 bg-light border rounded">-- SQL will appear here after generation</pre>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="generateSQLBtn">Generate SQL</button>
                    <button type="button" class="btn btn-success" id="executeSQLBtn" style="display: none;">Execute SQL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationMessage">
                    Are you sure you want to delete this file?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="successMessage">
                    Operation completed successfully.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let selectedFileId = null;
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        let deleteCallback = null;
        
        // Load files on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFiles();
            
            // Setup form submission
            document.getElementById('uploadForm').addEventListener('submit', uploadFile);
            
            // Setup schema generation
            document.getElementById('generateSQLBtn').addEventListener('click', generateSQL);
            document.getElementById('executeSQLBtn').addEventListener('click', executeSQL);
            
            // Setup delete buttons
            document.getElementById('deleteSelectedBtn').addEventListener('click', () => confirmDelete('single'));
            document.getElementById('deleteAllBtn').addEventListener('click', () => confirmDelete('all'));
            document.getElementById('confirmDeleteBtn').addEventListener('click', performDelete);
            
            // Setup schema tab
            document.getElementById('schema-tab').addEventListener('click', loadDatabaseSchema);
            document.getElementById('refreshSchemaBtn').addEventListener('click', loadDatabaseSchema);
        });
        
        // Load files from API
        async function loadFiles() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                renderFileList(files);
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }
        
        // Render file list
        function renderFileList(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (files.length === 0) {
                fileList.innerHTML = '<div class="list-group-item text-center text-muted">No files uploaded yet</div>';
                document.getElementById('deleteAllBtn').disabled = true;
                return;
            }
            
            document.getElementById('deleteAllBtn').disabled = false;
            
            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action file-card d-flex align-items-center';
                item.dataset.fileId = file.id;
                
                const sizeInKB = Math.round(file.file_size / 1024);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-grow-1';
                contentDiv.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${file.original_filename}</h6>
                        <small>${sizeInKB} KB</small>
                    </div>
                    <p class="mb-1 small text-muted">Rows: ${file.row_count || 'N/A'}</p>
                `;
                contentDiv.addEventListener('click', () => loadFilePreview(file.id));
                
                const deleteIcon = document.createElement('div');
                deleteIcon.className = 'ms-2 delete-btn';
                deleteIcon.innerHTML = '<i class="bi bi-x-circle"></i>';
                deleteIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    confirmDelete('single', file.id);
                });
                
                item.appendChild(contentDiv);
                item.appendChild(deleteIcon);
                fileList.appendChild(item);
            });
            
            // If the previously selected file is still in the list, keep it selected
            if (selectedFileId) {
                const selectedItem = document.querySelector(`.file-card[data-file-id="${selectedFileId}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                } else {
                    resetPreview();
                }
            }
        }
        
        // Load file preview
        async function loadFilePreview(fileId) {
            try {
                selectedFileId = fileId;
                
                // Update active file in list
                document.querySelectorAll('.file-card').forEach(card => {
                    card.classList.remove('active');
                    if (parseInt(card.dataset.fileId) === fileId) {
                        card.classList.add('active');
                    }
                });
                
                const response = await fetch(`/api/files/${fileId}/preview`);
                const preview = await response.json();
                
                // Show preview card, hide empty state
                document.getElementById('previewCard').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';
                
                // Update preview title
                document.getElementById('previewTitle').textContent = `Preview: ${preview.filename}`;
                
                // Update file info
                document.getElementById('fileInfo').textContent = `${preview.filename} - ${preview.row_count} rows`;
                
                // Render table header
                const headerRow = document.createElement('tr');
                preview.headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                document.getElementById('previewHeader').innerHTML = '';
                document.getElementById('previewHeader').appendChild(headerRow);
                
                // Render table body
                const tbody = document.getElementById('previewBody');
                tbody.innerHTML = '';
                
                preview.sample_data.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Error loading file preview:', error);
            }
        }
        
        // Reset preview
        function resetPreview() {
            selectedFileId = null;
            document.getElementById('previewCard').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }
        
        // Upload file
        async function uploadFile(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/files/', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    fileInput.value = '';
                    loadFiles();
                    
                    // Show success message
                    document.getElementById('successMessage').textContent = 'File uploaded successfully!';
                    successModal.show();
                } else {
                    const error = await response.json();
                    alert(`Upload failed: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('Error uploading file. Please try again.');
            }
        }
        
        // Generate SQL schema
        async function generateSQL() {
            if (!selectedFileId) {
                alert('Please select a file first');
                return;
            }
            
            const tableName = document.getElementById('tableName').value;
            if (!tableName) {
                alert('Please enter a table name');
                return;
            }
            
            const formData = new FormData();
            formData.append('table_name', tableName);
            
            try {
                const response = await fetch(`/api/files/${selectedFileId}/schema`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('generatedSQL').textContent = result.sql;
                    document.getElementById('executeSQLBtn').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert(`Schema generation failed: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error generating schema:', error);
                alert('Error generating schema. Please try again.');
            }
        }
        
        // Execute SQL schema
        async function executeSQL() {
            if (!selectedFileId) {
                alert('Please select a file first');
                return;
            }
            
            const tableName = document.getElementById('tableName').value;
            if (!tableName) {
                alert('Please enter a table name');
                return;
            }
            
            const formData = new FormData();
            formData.append('table_name', tableName);
            
            try {
                const response = await fetch(`/api/files/${selectedFileId}/execute-schema`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    document.getElementById('successMessage').textContent = result.message;
                    successModal.show();
                    
                    // Close the schema modal
                    const schemaModal = bootstrap.Modal.getInstance(document.getElementById('schemaModal'));
                    schemaModal.hide();
                } else {
                    const error = await response.json();
                    alert(`Schema execution failed: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error executing schema:', error);
                alert('Error executing schema. Please try again.');
            }
        }
        
        // Confirm delete
        function confirmDelete(type, fileId = null) {
            const targetFileId = fileId || selectedFileId;
            
            if (type === 'single' && !targetFileId) {
                alert('Please select a file first');
                return;
            }
            
            const message = type === 'all' 
                ? 'Are you sure you want to delete all files? This action cannot be undone.'
                : 'Are you sure you want to delete this file? This action cannot be undone.';
                
            document.getElementById('confirmationMessage').textContent = message;
            
            deleteCallback = () => {
                if (type === 'all') {
                    deleteAllFiles();
                } else {
                    deleteFile(targetFileId);
                }
            };
            
            confirmationModal.show();
        }
        
        // Perform delete (called from confirmation modal)
        function performDelete() {
            confirmationModal.hide();
            if (deleteCallback) {
                deleteCallback();
                deleteCallback = null;
            }
        }
        
        // Delete file
        async function deleteFile(fileId) {
            try {
                const response = await fetch(`/api/files/${fileId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // If we deleted the currently selected file, reset the preview
                    if (fileId === selectedFileId) {
                        resetPreview();
                    }
                    
                    // Reload the file list
                    loadFiles();
                    
                    // Show success message
                    document.getElementById('successMessage').textContent = result.message;
                    successModal.show();
                } else {
                    const error = await response.json();
                    alert(`Delete failed: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting file:', error);
                alert('Error deleting file. Please try again.');
            }
        }
        
        // Delete all files
        async function deleteAllFiles() {
            try {
                const response = await fetch(`/api/files/`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Reset the preview since all files are deleted
                    resetPreview();
                    
                    // Reload the file list
                    loadFiles();
                    
                    // Show success message
                    document.getElementById('successMessage').textContent = result.message;
                    successModal.show();
                } else {
                    const error = await response.json();
                    alert(`Delete failed: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting files:', error);
                alert('Error deleting files. Please try again.');
            }
        }
        
        // Load database schema
        async function loadDatabaseSchema() {
            // Show loading state
            document.getElementById('schemaLoading').style.display = 'block';
            document.getElementById('schemaEmpty').style.display = 'none';
            document.getElementById('schemaList').innerHTML = '';
            
            try {
                const response = await fetch('/api/files/schema/database');
                const schema = await response.json();
                
                // Hide loading state
                document.getElementById('schemaLoading').style.display = 'none';
                
                if (schema.length === 0) {
                    // Show empty state
                    document.getElementById('schemaEmpty').style.display = 'block';
                    return;
                }
                
                // Render schema information
                renderDatabaseSchema(schema);
            } catch (error) {
                console.error('Error loading database schema:', error);
                document.getElementById('schemaLoading').style.display = 'none';
                document.getElementById('schemaList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading schema information: ${error.message}
                    </div>
                `;
            }
        }
        
        // Render database schema
        function renderDatabaseSchema(schema) {
            const schemaList = document.getElementById('schemaList');
            schemaList.innerHTML = '';
            
            schema.forEach(table => {
                const tableCard = document.createElement('div');
                tableCard.className = 'card schema-card';
                
                // Table header
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                cardHeader.innerHTML = `
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2"></i>
                        ${table.name}
                    </h5>
                `;
                
                // Table content
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                // Columns
                const columnsTable = document.createElement('table');
                columnsTable.className = 'table table-sm table-striped schema-table';
                
                // Table header
                const tHead = document.createElement('thead');
                tHead.innerHTML = `
                    <tr>
                        <th>Column</th>
                        <th>Type</th>
                        <th>Nullable</th>
                        <th>Key</th>
                    </tr>
                `;
                columnsTable.appendChild(tHead);
                
                // Table body
                const tBody = document.createElement('tbody');
                table.columns.forEach(column => {
                    const tr = document.createElement('tr');
                    const isPrimaryKey = table.primary_keys.includes(column.name);
                    
                    tr.innerHTML = `
                        <td>${column.name}</td>
                        <td><code>${column.type}</code></td>
                        <td>${column.nullable ? 'Yes' : 'No'}</td>
                        <td>${isPrimaryKey ? '<span class="badge bg-primary">PK</span>' : ''}</td>
                    `;
                    tBody.appendChild(tr);
                });
                columnsTable.appendChild(tBody);
                
                cardBody.appendChild(columnsTable);
                
                // Add indexes if any
                if (table.indexes.length > 0) {
                    const indexesTitle = document.createElement('h6');
                    indexesTitle.className = 'mt-3';
                    indexesTitle.textContent = 'Indexes';
                    cardBody.appendChild(indexesTitle);
                    
                    const indexesList = document.createElement('ul');
                    indexesList.className = 'list-group list-group-flush';
                    
                    table.indexes.forEach(index => {
                        const indexItem = document.createElement('li');
                        indexItem.className = 'list-group-item py-2';
                        indexItem.innerHTML = `
                            <div class="d-flex align-items-center">
                                <span class="badge ${index.unique ? 'bg-success' : 'bg-secondary'} me-2">
                                    ${index.unique ? 'UNIQUE' : 'INDEX'}
                                </span>
                                <span>${index.name}: ${index.columns.join(', ')}</span>
                            </div>
                        `;
                        indexesList.appendChild(indexItem);
                    });
                    
                    cardBody.appendChild(indexesList);
                }
                
                // Add foreign keys if any
                if (table.foreign_keys.length > 0) {
                    const fksTitle = document.createElement('h6');
                    fksTitle.className = 'mt-3';
                    fksTitle.textContent = 'Foreign Keys';
                    cardBody.appendChild(fksTitle);
                    
                    const fksList = document.createElement('ul');
                    fksList.className = 'list-group list-group-flush';
                    
                    table.foreign_keys.forEach(fk => {
                        const fkItem = document.createElement('li');
                        fkItem.className = 'list-group-item py-2';
                        fkItem.innerHTML = `
                            <div>
                                <span class="badge bg-info me-2">FK</span>
                                <span>${fk.column.join(', ')} → ${fk.referred_table}(${fk.referred_columns.join(', ')})</span>
                            </div>
                        `;
                        fksList.appendChild(fkItem);
                    });
                    
                    cardBody.appendChild(fksList);
                }
                
                tableCard.appendChild(cardHeader);
                tableCard.appendChild(cardBody);
                schemaList.appendChild(tableCard);
            });
        }
    </script>
</body>
</html> 